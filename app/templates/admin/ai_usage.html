{% extends "base.html" %}
{% block title %}AI Usage Dashboard ‚Äì Admin{% endblock %}

{% block content %}
<div class="page-shell">

  <!-- Skeleton -->
  <div id="skelAI">
    <div class="skeleton" style="width:200px;height:28px;margin-bottom:var(--sp-2);"></div>
    <div class="skeleton" style="width:300px;height:14px;margin-bottom:var(--sp-8);"></div>
    <div class="grid grid-3 gap-4 mb-8">
      {% for i in range(3) %}<div class="skeleton" style="height:110px;border-radius:var(--radius-lg);"></div>{% endfor
      %}
    </div>
    <div class="skeleton" style="height:260px;border-radius:var(--radius-xl);"></div>
  </div>

  <div id="realAI" style="display:none;">

    <!-- Header -->
    <div class="page-header anim-fade">
      <div class="page-header-icon" style="background:linear-gradient(135deg,#8b5cf6,#06b6d4);">ü§ñ</div>
      <div>
        <h1>AI Usage Dashboard</h1>
        <p>Monitor Gemini model calls, failures, and fallback activity.</p>
      </div>
      <a href="{{ url_for('admin.index') }}" class="btn btn-secondary" style="margin-left:auto;">‚Üê Back</a>
    </div>

    <!-- Stat cards -->
    <div class="grid grid-3 gap-4 mb-8">
      <div class="stat-card anim-slide anim-stagger" style="--i:0;">
        <div class="stat-card-icon" style="background:rgba(99,102,241,.1);color:#6366f1;">üî¢</div>
        <div class="stat-card-value">{{ total_calls }}</div>
        <div class="stat-card-label">Total API Calls</div>
      </div>
      <div class="stat-card anim-slide anim-stagger" style="--i:1;">
        <div class="stat-card-icon" style="background:rgba(239,68,68,.1);color:#ef4444;">‚ö†Ô∏è</div>
        <div class="stat-card-value">{{ total_failures }}</div>
        <div class="stat-card-label">Total Failures</div>
      </div>
      <div class="stat-card anim-slide anim-stagger" style="--i:2;">
        <div class="stat-card-icon" style="background:rgba(16,185,129,.1);color:#10b981;">‚úÖ</div>
        <div class="stat-card-value">{{ active_models }}</div>
        <div class="stat-card-label">Active Models</div>
      </div>
    </div>

    <!-- Cooldown alert -->
    {% if cooldowns %}
    <div class="alert alert-warning mb-6" style="font-size:var(--fs-sm);">
      <strong>‚è≥ Models in cooldown:</strong>
      {% for model, expires in cooldowns.items() %}
      <span class="badge badge-danger" style="margin-left:var(--sp-2);">{{ model }} ‚Üí {{ expires.strftime('%H:%M:%S')
        }}</span>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Today's stats -->
    {% if today_stats %}
    <div class="card anim-slide anim-stagger mb-6" style="--i:3;">
      <div style="padding:var(--sp-5) var(--sp-6);border-bottom:1px solid var(--border-light);">
        <h3 style="margin:0;font-size:var(--fs-md);">üìä Today's Usage</h3>
      </div>
      <div class="table-wrap">
        <table class="premium-table">
          <thead>
            <tr>
              <th>Model</th>
              <th>Success</th>
              <th>Failures</th>
              <th>Total</th>
              <th>Status</th>
              <th>Last Failure</th>
            </tr>
          </thead>
          <tbody>
            {% for stat in today_stats %}
            <tr>
              <td><span style="font-weight:700;color:var(--text-primary);">{{ stat.model_name }}</span></td>
              <td><span style="color:var(--success);font-weight:600;">{{ stat.success_count }}</span></td>
              <td><span style="color:var(--error);font-weight:600;">{{ stat.failure_count }}</span></td>
              <td>{{ stat.total_calls }}</td>
              <td>
                {% if stat.status == 'active' %}
                <span class="badge badge-success">Active</span>
                {% else %}
                <span class="badge badge-danger">Degraded</span>
                {% endif %}
              </td>
              <td style="font-size:var(--fs-xs);color:var(--text-faint);">
                {{ stat.last_failure_at.strftime('%H:%M:%S') if stat.last_failure_at else '‚Äî' }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% else %}
    <div class="card text-center anim-slide anim-stagger mb-6" style="--i:3;padding:var(--sp-8);">
      <div style="font-size:var(--fs-2xl);margin-bottom:var(--sp-3);">ü§ñ</div>
      <p style="color:var(--text-muted);">No AI calls made today yet.</p>
    </div>
    {% endif %}

    <!-- All-time stats -->
    {% if all_time %}
    <div class="card anim-slide anim-stagger" style="--i:4;">
      <div style="padding:var(--sp-5) var(--sp-6);border-bottom:1px solid var(--border-light);">
        <h3 style="margin:0;font-size:var(--fs-md);">üèÜ All-Time Model Performance</h3>
      </div>
      <div class="table-wrap">
        <table class="premium-table">
          <thead>
            <tr>
              <th>Model</th>
              <th>Total Success</th>
              <th>Total Failures</th>
              <th>Success Rate</th>
              <th>Last Failure</th>
            </tr>
          </thead>
          <tbody>
            {% for row in all_time %}
            <tr>
              <td><span style="font-weight:700;color:var(--text-primary);">{{ row.model_name }}</span></td>
              <td><span style="color:var(--success);font-weight:600;">{{ row.total_success or 0 }}</span></td>
              <td><span style="color:var(--error);font-weight:600;">{{ row.total_failure or 0 }}</span></td>
              <td>
                {% set total = (row.total_success or 0) + (row.total_failure or 0) %}
                {% if total > 0 %}
                <span style="font-weight:600;color:var(--primary);">{{ '%.0f'|format(((row.total_success or 0) / total)
                  * 100) }}%</span>
                {% else %}
                <span class="text-faint">‚Äî</span>
                {% endif %}
              </td>
              <td style="font-size:var(--fs-xs);color:var(--text-faint);">
                {{ row.last_failure.strftime('%b %d, %H:%M') if row.last_failure else '‚Äî' }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}

  </div>
</div>

<script>
  setTimeout(() => {
    document.getElementById('skelAI').style.display = 'none';
    document.getElementById('realAI').style.display = 'block';
  }, 800);
</script>
{% endblock %}