{% extends "base.html" %}
{% block title %}{{ attempt.quiz.title }} – Quiz{% endblock %}

{% block content %}
<div class="page-shell" style="max-width:var(--max-w-lg);">

  <!-- Header -->
  <div class="flex items-center justify-between mb-4 anim-fade" style="flex-wrap:wrap;gap:var(--sp-3);">
    <h2 style="margin:0;font-size:var(--fs-xl);color:var(--primary);">{{ attempt.quiz.title }}</h2>
    <div class="flex items-center gap-3">
      {% if time_remaining is not none %}
      <div class="badge badge-danger" style="padding:var(--sp-2) var(--sp-3);font-size:var(--fs-sm);">
        ⏱️ <span id="timer-display">--:--</span>
      </div>
      {% endif %}
      <span class="badge badge-neutral" style="padding:var(--sp-2) var(--sp-3);font-size:var(--fs-sm);">Q {{
        current_index }}/{{ total }}</span>
    </div>
  </div>

  <!-- Progress -->
  <div class="progress mb-6">
    <div class="progress-fill" style="--progress-width:{{ ((current_index - 1) / total) * 100 }}%;"></div>
  </div>

  {% if question %}
  <div class="glass-card anim-scale">
    <h3 style="font-size:var(--fs-lg);line-height:1.5;margin-bottom:var(--sp-8);">{{ question.question_text }}</h3>
    <form method="POST" action="{{ url_for('attempt.take_quiz', attempt_id=attempt.id) }}">
      <input type="hidden" name="question_id" value="{{ question.id }}">
      <div class="flex flex-col gap-3 mb-6">
        {% for opt_val, opt_text in [('A', question.option_a), ('B', question.option_b), ('C', question.option_c), ('D',
        question.option_d)] %}
        <label class="quiz-option">
          <input type="radio" name="selected_option" value="{{ opt_val }}" required>
          <span class="quiz-option-text">{{ opt_text }}</span>
        </label>
        {% endfor %}
      </div>
      <div style="text-align:right;">
        {% if is_last %}
        <button type="submit" name="action" value="finish" class="btn btn-primary btn-lg">Submit Quiz</button>
        {% else %}
        <button type="submit" name="action" value="next" class="btn btn-primary btn-lg">Next →</button>
        {% endif %}
      </div>
    </form>
  </div>
  {% else %}
  <div class="glass-card text-center anim-fade" style="padding:var(--sp-12);">
    <div style="font-size:2.5rem;margin-bottom:var(--sp-3);">✅</div>
    <h3 style="margin-bottom:var(--sp-2);">All questions answered!</h3>
    <p class="text-muted mb-6">Ready to submit?</p>
    <form method="POST" action="{{ url_for('attempt.take_quiz', attempt_id=attempt.id) }}">
      <button type="submit" name="action" value="finish" class="btn btn-primary btn-lg">Submit Final Answers</button>
    </form>
  </div>
  {% endif %}
</div>

<style>
  .quiz-option {
    display: flex;
    align-items: center;
    gap: var(--sp-4);
    padding: var(--sp-4);
    border: 1.5px solid var(--border-color);
    border-radius: var(--radius-md);
    cursor: pointer;
    background: rgba(255, 255, 255, .6);
    transition: all var(--dur-md) var(--ease);
  }

  .quiz-option:hover {
    border-color: var(--primary);
    background: var(--primary-light);
  }

  .quiz-option input[type="radio"] {
    transform: scale(1.2);
    accent-color: var(--primary);
  }

  .quiz-option:has(input:checked) {
    background: #eef2ff;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-ring);
  }

  .quiz-option-text {
    font-size: var(--fs-base);
    font-weight: 500;
  }
</style>

{% if time_remaining is not none %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    let t = parseInt("{{ time_remaining }}", 10);
    const d = document.getElementById('timer-display');
    let done = false;
    function tick() {
      if (t <= 0) { d.textContent = "00:00"; if (!done) { done = true; const f = document.querySelector('form'); if (f) { const i = document.createElement('input'); i.type = 'hidden'; i.name = 'action'; i.value = 'finish'; f.appendChild(i); f.submit(); } } return; }
      d.textContent = (Math.floor(t / 60) < 10 ? '0' : '') + Math.floor(t / 60) + ':' + (t % 60 < 10 ? '0' : '') + (t % 60);
      t--;
    }
    tick(); setInterval(tick, 1000);
  });
</script>
{% endif %}
{% endblock %}