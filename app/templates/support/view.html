{% extends "base.html" %}
{% block title %}{{ ticket.subject }} â€“ Support{% endblock %}

{% block content %}
<div class="page-shell" style="max-width:var(--max-w-lg);">

  <div class="flex items-center justify-between mb-6 anim-fade" style="flex-wrap:wrap;gap:var(--sp-3);">
    <a href="{{ url_for('support.list_tickets') }}"
      style="font-weight:600;font-size:var(--fs-sm);color:var(--text-muted);">â† Back to Tickets</a>
    {% if ticket.status == 'open' %}
    <form method="POST" action="{{ url_for('support.view_ticket', ticket_id=ticket.id) }}"
      onsubmit="return confirm('Close this ticket?');">
      <input type="hidden" name="action" value="close">
      <button type="submit" class="btn btn-danger btn-sm">Close Ticket</button>
    </form>
    {% endif %}
  </div>

  <div class="alerts">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}{% for cat, msg in messages %}
    <div class="alert alert-{{ cat }}">{{ msg }}</div>
    {% endfor %}{% endif %}{% endwith %}
  </div>

  <!-- Original ticket -->
  <div class="glass-card mb-6 anim-slide">
    <div class="flex items-center justify-between mb-4"
      style="padding-bottom:var(--sp-4);border-bottom:1px solid rgba(0,0,0,.05);flex-wrap:wrap;gap:var(--sp-3);">
      <div>
        <h2 style="margin:0;font-size:var(--fs-2xl);">{{ ticket.subject }}</h2>
        <div style="font-size:var(--fs-sm);color:var(--text-faint);margin-top:var(--sp-1);">
          By <strong>{{ ticket.user.username }}</strong> Â· {{ ticket.created_at.strftime('%b %d, %Y at %H:%M') }}
        </div>
      </div>
      {% if ticket.status == 'open' %}<span class="badge badge-success">Open</span>
      {% else %}<span class="badge badge-neutral">Closed</span>{% endif %}
    </div>
    <div style="font-size:var(--fs-base);line-height:1.6;white-space:pre-wrap;color:var(--text-secondary);">{{
      ticket.message }}</div>
  </div>

  <!-- Thread -->
  {% if ticket.replies.count() > 0 %}
  <h3 class="mb-4" style="font-size:var(--fs-md);">ğŸ’¬ Conversation</h3>
  <div class="flex flex-col gap-4 mb-6">
    {% for reply in ticket.replies %}
    <div class="flex gap-3 anim-slide anim-stagger"
      style="--i:{{ loop.index0 }};{% if reply.user_id != ticket.user_id %}margin-left:var(--sp-8);{% endif %}">
      {% if reply.user.profile_image %}
      <img src="{{ url_for('static', filename=reply.user.profile_image) }}" alt="Avatar"
        class="avatar avatar-sm {% if reply.user.is_admin %}border-success{% endif %}"
        style="object-fit:cover;flex-shrink:0;">
      {% else %}
      <div class="avatar avatar-sm {% if reply.user.is_admin %}{% endif %}"
        style="{% if reply.user.is_admin %}background:linear-gradient(135deg,var(--success),#0ea5e9);{% endif %}flex-shrink:0;">
        {{ reply.user.username[0]|upper }}</div>
      {% endif %}
      <div class="card"
        style="flex:1;padding:var(--sp-4);{% if reply.user.is_admin %}background:rgba(16,185,129,.03);border:1px solid rgba(16,185,129,.1);{% endif %}border-radius:var(--radius-md);">
        <div class="flex items-center justify-between mb-2">
          <span style="font-weight:700;font-size:var(--fs-sm);color:var(--text-primary);">
            {{ reply.user.username }}
            {% if reply.user.is_admin %}<span class="badge badge-success"
              style="margin-left:var(--sp-2);">Admin</span>{% endif %}
          </span>
          <span style="font-size:var(--fs-xs);color:var(--text-faint);">{{ reply.created_at.strftime('%b %d, %H:%M')
            }}</span>
        </div>
        <div style="font-size:var(--fs-sm);line-height:1.5;white-space:pre-wrap;color:var(--text-secondary);">{{
          reply.message }}</div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Reply form -->
  {% if ticket.status == 'open' %}
  <div class="glass-card anim-slide" style="border:1.5px solid var(--primary);">
    <h3 style="margin:0 0 var(--sp-4);font-size:var(--fs-md);color:var(--primary);">Add a Reply</h3>
    <form method="POST" action="{{ url_for('support.view_ticket', ticket_id=ticket.id) }}">
      <input type="hidden" name="action" value="reply">
      <div class="form-group">
        <textarea name="message" class="form-control" rows="4" required placeholder="Type your messageâ€¦"></textarea>
      </div>
      <button type="submit" class="btn btn-primary">Post Reply</button>
    </form>
  </div>
  {% else %}
  <div class="text-center"
    style="padding:var(--sp-6);background:rgba(0,0,0,.03);border-radius:var(--radius-md);color:var(--text-muted);font-weight:600;">
    This ticket has been closed.
  </div>
  {% endif %}
</div>
{% endblock %}