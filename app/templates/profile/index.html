{% extends "base.html" %}
{% block title %}My Profile â€“ Quizz{% endblock %}

{% block content %}
<div class="page-shell" style="max-width:var(--max-w-lg);">

  <div class="page-header anim-fade">
    <div class="page-header-icon" style="background:linear-gradient(135deg,var(--primary),#8b5cf6);">ğŸ‘¤</div>
    <div>
      <h1>My Profile</h1>
      <p>Manage your account settings and personal information.</p>
    </div>
  </div>

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}{% for cat, msg in messages %}
  <div class="alert alert-{{ cat }} mb-4">{{ msg }}</div>
  {% endfor %}{% endif %}{% endwith %}

  <!-- Profile completion -->
  {% if completion < 100 %} <div class="glass-card-static mb-6 anim-slide" style="padding:var(--sp-4) var(--sp-6);">
    <div class="flex items-center justify-between mb-2">
      <span style="font-size:var(--fs-sm);font-weight:600;color:var(--text-primary);">Profile Completion</span>
      <span style="font-size:var(--fs-sm);font-weight:700;color:var(--primary);">{{ completion }}%</span>
    </div>
    <div class="progress">
      <div class="progress-fill" style="--progress-width:{{ completion }}%;"></div>
    </div>
</div>
{% endif %}

<!-- Admin stats -->
{% if current_user.is_admin %}
<div class="grid grid-4 gap-4 mb-8">
  <div class="stat-card anim-slide anim-stagger" style="--i:0;">
    <div class="stat-card-value">{{ total_users }}</div>
    <div class="stat-card-label">Users Managed</div>
  </div>
  <div class="stat-card anim-slide anim-stagger" style="--i:1;">
    <div class="stat-card-value">{{ total_quizzes }}</div>
    <div class="stat-card-label">Quizzes</div>
  </div>
  <div class="stat-card anim-slide anim-stagger" style="--i:2;">
    <div class="stat-card-value" style="color:var(--primary);">{{ admin_activity_count }}</div>
    <div class="stat-card-label">Your Activities</div>
  </div>
  <div class="stat-card anim-slide anim-stagger" style="--i:3;">
    <div class="stat-card-value" style="color:var(--warning);">{{ total_tickets }}</div>
    <div class="stat-card-label">Tickets</div>
  </div>
</div>
{% endif %}

<!-- Main profile card -->
<div class="grid gap-6 mb-8" style="grid-template-columns:280px 1fr;align-items:start;">

  <!-- Left: Avatar & Info -->
  <div class="glass-card text-center anim-slide" style="--i:0;">
    <!-- Avatar -->
    <div
      style="position:relative;width:120px;height:120px;margin:0 auto var(--sp-4);border-radius:var(--radius-full);overflow:hidden;border:3px solid var(--primary);box-shadow:0 4px 16px rgba(99,102,241,.25);">
      {% if current_user.profile_image %}
      <img src="{{ url_for('static', filename=current_user.profile_image) }}" alt="Avatar"
        style="width:100%;height:100%;object-fit:cover;" id="avatarPreview">
      {% else %}
      <div id="avatarPreview"
        style="width:100%;height:100%;background:linear-gradient(135deg,var(--primary),#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:3rem;font-weight:900;color:white;">
        {{ current_user.username[0]|upper }}
      </div>
      {% endif %}
    </div>

    <!-- Upload form -->
    <form method="POST" action="{{ url_for('profile.upload_avatar') }}" enctype="multipart/form-data"
      style="margin-bottom:var(--sp-4);">
      <label class="btn btn-secondary btn-sm" style="cursor:pointer;display:inline-block;">
        ğŸ“· Change Photo
        <input type="file" name="avatar" accept=".jpg,.jpeg,.png,.webp" style="display:none;"
          onchange="previewAvatar(this); this.form.submit();">
      </label>
      <div style="font-size:var(--fs-xs);color:var(--text-faint);margin-top:var(--sp-2);">Max 2MB Â· JPG, PNG, WebP</div>
    </form>

    <!-- Role badge -->
    <div class="mb-3">
      {% if current_user.is_admin %}
      <span class="badge badge-success" style="font-size:var(--fs-sm);padding:var(--sp-2) var(--sp-3);">ğŸ›¡ï¸ Admin</span>
      {% else %}
      <span class="badge badge-primary" style="font-size:var(--fs-sm);padding:var(--sp-2) var(--sp-3);">ğŸ‘¤ User</span>
      {% endif %}
    </div>

    <div style="font-size:var(--fs-sm);color:var(--text-primary);font-weight:700;">{{ current_user.username }}</div>
    <div style="font-size:var(--fs-xs);color:var(--text-faint);margin-top:var(--sp-1);">Joined {{
      current_user.joined_at.strftime('%b %Y') }}</div>
  </div>

  <!-- Right: Profile form -->
  <div class="glass-card anim-slide" style="--i:1;">
    <h3 style="margin:0 0 var(--sp-6);font-size:var(--fs-lg);">âœï¸ Personal Information</h3>
    <form method="POST" action="{{ url_for('profile.update') }}">
      <div class="form-group">
        <label class="form-label">Full Name</label>
        <input type="text" name="full_name" class="form-control" value="{{ current_user.full_name or '' }}"
          placeholder="Enter your full name">
      </div>
      <div class="form-group">
        <label class="form-label">Email Address</label>
        <input type="email" name="email" class="form-control" value="{{ current_user.email }}" required>
      </div>
      <div class="form-group">
        <label class="form-label">Bio <span class="form-hint">(Optional)</span></label>
        <textarea name="bio" class="form-control" rows="3"
          placeholder="Tell us about yourselfâ€¦">{{ current_user.bio or '' }}</textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Username</label>
        <input type="text" class="form-control" value="{{ current_user.username }}" disabled
          style="opacity:.6;cursor:not-allowed;">
        <div style="font-size:var(--fs-xs);color:var(--text-faint);margin-top:var(--sp-1);">Username cannot be changed.
        </div>
      </div>
      <button type="submit" class="btn btn-primary btn-block mt-4">Save Changes</button>
    </form>
  </div>
</div>

<!-- Password change -->
{% if not current_user.google_id %}
<div class="glass-card anim-slide mb-8" style="--i:2;border:1.5px solid rgba(239,68,68,.15);">
  <h3 style="margin:0 0 var(--sp-6);font-size:var(--fs-lg);">ğŸ” Change Password</h3>
  <form method="POST" action="{{ url_for('profile.change_password') }}">
    <div class="grid gap-4" style="grid-template-columns:1fr 1fr 1fr;">
      <div class="form-group">
        <label class="form-label">Current Password</label>
        <input type="password" name="current_password" class="form-control" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <div class="form-group">
        <label class="form-label">New Password</label>
        <input type="password" name="new_password" class="form-control" required placeholder="Min 8 chars, 1 number">
      </div>
      <div class="form-group">
        <label class="form-label">Confirm Password</label>
        <input type="password" name="confirm_password" class="form-control" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
    </div>
    <button type="submit" class="btn btn-danger mt-4">Update Password</button>
  </form>
</div>
{% else %}
<div class="glass-card-static mb-8" style="padding:var(--sp-5) var(--sp-6);">
  <p style="font-size:var(--fs-sm);color:var(--text-muted);margin:0;">ğŸ”— Your account is linked to Google. Password is
    managed through your Google account.</p>
</div>
{% endif %}

<!-- Account info -->
<div class="glass-card-static anim-slide" style="--i:3;padding:var(--sp-5) var(--sp-6);">
  <h3 style="margin:0 0 var(--sp-4);font-size:var(--fs-md);">ğŸ“‹ Account Details</h3>
  <div class="grid grid-2 gap-3" style="font-size:var(--fs-sm);">
    <div><span class="text-faint">User ID:</span> <strong>{{ current_user.id }}</strong></div>
    <div><span class="text-faint">Role:</span> <strong>{{ 'Admin' if current_user.is_admin else 'User' }}</strong></div>
    <div><span class="text-faint">Joined:</span> <strong>{{ current_user.joined_at.strftime('%b %d, %Y') }}</strong>
    </div>
    <div><span class="text-faint">Last Login:</span> <strong>{{ current_user.last_login.strftime('%b %d, %Y %H:%M') if
        current_user.last_login else 'N/A' }}</strong></div>
  </div>
</div>

</div>

<style>
  /* Responsive: stack on mobile */
  @media (max-width: 768px) {
    .page-shell .grid[style*="280px"] {
      grid-template-columns: 1fr !important;
    }

    .glass-card.text-center .avatar-wrap {
      margin: 0 auto;
    }

    .grid[style*="1fr 1fr 1fr"] {
      grid-template-columns: 1fr !important;
    }
  }
</style>

<script>
  function previewAvatar(input) {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const preview = document.getElementById('avatarPreview');
        if (preview.tagName === 'IMG') {
          preview.src = e.target.result;
        } else {
          // Replace div with img
          const img = document.createElement('img');
          img.src = e.target.result;
          img.style.cssText = 'width:100%;height:100%;object-fit:cover;';
          img.id = 'avatarPreview';
          preview.parentNode.replaceChild(img, preview);
        }
      };
      reader.readAsDataURL(input.files[0]);
    }
  }
</script>
{% endblock %}