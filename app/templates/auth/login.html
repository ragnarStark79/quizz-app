{% extends "base.html" %}
{% block title %}Login â€“ Quizz{% endblock %}

{% block content %}
<div style="display:flex;align-items:center;justify-content:center;min-height:calc(100vh - 200px);">
  <div class="glass-card anim-scale" style="max-width:var(--max-w-sm);width:100%;">
    <div class="text-center mb-8">
      <div style="font-size:2.5rem;margin-bottom:var(--sp-3);">ðŸ‘‹</div>
      <h2 style="margin-bottom:var(--sp-2);">Welcome Back</h2>
      <p class="text-muted" style="font-size:var(--fs-sm);">Sign in to continue your learning journey.</p>
    </div>

    <div class="alerts">
      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}{% for category, message in messages %}
      <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}{% endif %}{% endwith %}
    </div>

    <form method="POST" action="{{ url_for('auth.login') }}">
      <div class="form-group">
        <label class="form-label" for="email">Email</label>
        <input type="email" id="email" name="email" class="form-control" required autofocus
          placeholder="you@example.com">
      </div>
      <div class="form-group">
        <label class="form-label" for="password">Password</label>
        <input type="password" id="password" name="password" class="form-control" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <button type="submit" class="btn btn-primary btn-block btn-lg">Sign In</button>
    </form>

    <!-- Divider -->
    <div style="display:flex;align-items:center;gap:var(--sp-3);margin:var(--sp-5) 0;">
      <div style="flex:1;height:1px;background:var(--border-light);"></div>
      <span style="font-size:var(--fs-xs);color:var(--text-faint);font-weight:500;white-space:nowrap;">or continue
        with</span>
      <div style="flex:1;height:1px;background:var(--border-light);"></div>
    </div>

    <!-- Google Sign In Button -->
    <button id="googleSignInBtn" onclick="signInWithGoogle()" class="btn btn-block btn-lg"
      style="background:#fff;color:#1f1f1f;border:1.5px solid var(--border-light);font-weight:600;display:flex;align-items:center;justify-content:center;gap:var(--sp-3);transition:all var(--dur) var(--ease);"
      onmouseover="this.style.borderColor='var(--primary)';this.style.boxShadow='0 2px 12px rgba(99,102,241,.12)';"
      onmouseout="this.style.borderColor='var(--border-light)';this.style.boxShadow='none';">
      <svg width="18" height="18" viewBox="0 0 48 48">
        <path fill="#EA4335"
          d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z" />
        <path fill="#4285F4"
          d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z" />
        <path fill="#FBBC05" d="M10.53 28.59a14.5 14.5 0 0 1 0-9.18l-7.98-6.19a24.01 24.01 0 0 0 0 21.56l7.98-6.19z" />
        <path fill="#34A853"
          d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z" />
      </svg>
      <span id="googleBtnText">Sign in with Google</span>
    </button>

    <p class="text-center mt-6" style="font-size:var(--fs-sm);color:var(--text-muted);">
      Don't have an account? <a href="{{ url_for('auth.register') }}" style="font-weight:700;">Create one</a>
    </p>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script>
  // Firebase config â€” replace with your project values
  const firebaseConfig = {
    apiKey: "{{ config.get('FIREBASE_API_KEY', '') }}",
    authDomain: "{{ config.get('FIREBASE_AUTH_DOMAIN', '') }}",
    projectId: "{{ config.get('FIREBASE_PROJECT_ID', '') }}",
  };
  firebase.initializeApp(firebaseConfig);

  async function signInWithGoogle() {
    const btn = document.getElementById('googleSignInBtn');
    const btnText = document.getElementById('googleBtnText');
    btn.disabled = true;
    btnText.textContent = 'Signing inâ€¦';

    try {
      const provider = new firebase.auth.GoogleAuthProvider();
      const result = await firebase.auth().signInWithPopup(provider);
      const idToken = await result.user.getIdToken();

      const response = await fetch('/auth/google-login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ idToken })
      });

      const data = await response.json();
      if (data.success) {
        window.location.href = data.redirect;
      } else {
        alert(data.error || 'Login failed. Please try again.');
        btn.disabled = false;
        btnText.textContent = 'Sign in with Google';
      }
    } catch (error) {
      console.error('Google sign-in error:', error);
      if (error.code !== 'auth/popup-closed-by-user') {
        alert('Google sign-in failed. Please try again.');
      }
      btn.disabled = false;
      btnText.textContent = 'Sign in with Google';
    }
  }
</script>
{% endblock %}