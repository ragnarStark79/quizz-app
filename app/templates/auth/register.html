{% extends "base.html" %}
{% block title %}Register â€“ QuizOasis{% endblock %}

{% block content %}
<div style="display:flex;align-items:center;justify-content:center;min-height:calc(100vh - 200px);">
  <div class="glass-card anim-scale" style="max-width:var(--max-w-sm);width:100%;">
    <div class="text-center mb-8">
      <div style="font-size:2.5rem;margin-bottom:var(--sp-3);">ðŸš€</div>
      <h2 style="margin-bottom:var(--sp-2);">Create an Account</h2>
      <p class="text-muted" style="font-size:var(--fs-sm);">Join the community. Start learning today.</p>
    </div>

    <div class="alerts">
      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}{% for category, message in messages %}
      <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}{% endif %}{% endwith %}
    </div>

    <!-- Google Sign Up Button (always enabled) -->
    <button id="googleSignUpBtn" onclick="signUpWithGoogle()" class="btn btn-block btn-lg mb-4"
      style="background:#fff;color:#1f1f1f;border:1.5px solid var(--border-light);font-weight:600;display:flex;align-items:center;justify-content:center;gap:var(--sp-3);transition:all var(--dur) var(--ease);"
      onmouseover="this.style.borderColor='var(--primary)';this.style.boxShadow='0 2px 12px rgba(99,102,241,.12)';"
      onmouseout="this.style.borderColor='var(--border-light)';this.style.boxShadow='none';">
      <svg width="18" height="18" viewBox="0 0 48 48">
        <path fill="#EA4335"
          d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z" />
        <path fill="#4285F4"
          d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z" />
        <path fill="#FBBC05" d="M10.53 28.59a14.5 14.5 0 0 1 0-9.18l-7.98-6.19a24.01 24.01 0 0 0 0 21.56l7.98-6.19z" />
        <path fill="#34A853"
          d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z" />
      </svg>
      <span id="googleBtnText">Sign up with Google</span>
    </button>

    <!-- Divider -->
    <div style="display:flex;align-items:center;gap:var(--sp-3);margin:0 0 var(--sp-5);">
      <div style="flex:1;height:1px;background:var(--border-light);"></div>
      <span style="font-size:var(--fs-xs);color:var(--text-faint);font-weight:500;white-space:nowrap;">or register with
        email</span>
      <div style="flex:1;height:1px;background:var(--border-light);"></div>
    </div>

    {% if not email_auth_enabled %}
    <!-- Maintenance Banner -->
    <div
      style="background:linear-gradient(135deg,#fef3c7,#fde68a);border:1px solid #f59e0b;border-radius:var(--radius);padding:var(--sp-4);margin-bottom:var(--sp-4);text-align:center;">
      <div style="font-size:1.3rem;margin-bottom:var(--sp-1);">ðŸ”’</div>
      <p style="font-size:var(--fs-sm);font-weight:600;color:#92400e;margin:0 0 var(--sp-1);">Email registration is
        under maintenance</p>
      <p style="font-size:var(--fs-xs);color:#a16207;margin:0;">Will be available soon with email verification feature.
        Please use Google Sign-Up for now.</p>
    </div>
    {% endif %}

    <form method="POST" action="{{ url_for('auth.register') }}" id="emailRegisterForm">
      <div class="form-group">
        <label class="form-label" for="username">Username</label>
        <input type="text" id="username" name="username" class="form-control" required autofocus placeholder="johndoe"
          {% if not email_auth_enabled %}disabled style="opacity:0.5;cursor:not-allowed;" {% endif %}>
      </div>
      <div class="form-group">
        <label class="form-label" for="email">Email</label>
        <input type="email" id="email" name="email" class="form-control" required placeholder="you@example.com" {% if
          not email_auth_enabled %}disabled style="opacity:0.5;cursor:not-allowed;" {% endif %}>
      </div>
      <div class="form-group">
        <label class="form-label" for="password">Password</label>
        <input type="password" id="password" name="password" class="form-control" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" {% if
          not email_auth_enabled %}disabled style="opacity:0.5;cursor:not-allowed;" {% endif %}>
      </div>
      <button type="submit" id="emailRegisterBtn" class="btn btn-primary btn-block btn-lg" {% if not email_auth_enabled
        %}disabled style="opacity:0.5;cursor:not-allowed;" title="Email registration is disabled. Use Google Sign-Up."
        {% endif %}>
        {% if not email_auth_enabled %}ðŸ”’ Registration Disabled{% else %}Create Account{% endif %}
      </button>
    </form>

    <p class="text-center mt-6" style="font-size:var(--fs-sm);color:var(--text-muted);">
      Already have an account? <a href="{{ url_for('auth.login') }}" style="font-weight:700;">Sign in</a>
    </p>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "{{ config.get('FIREBASE_API_KEY', '') }}",
    authDomain: "{{ config.get('FIREBASE_AUTH_DOMAIN', '') }}",
    projectId: "{{ config.get('FIREBASE_PROJECT_ID', '') }}",
  };
  firebase.initializeApp(firebaseConfig);

  // Block email form submission if disabled
  {% if not email_auth_enabled %}
  document.getElementById('emailRegisterForm').addEventListener('submit', function (e) {
    e.preventDefault();
    alert('Email registration is currently disabled. Please use Google Sign-Up.');
  });
  {% endif %}

  async function signUpWithGoogle() {
    const btn = document.getElementById('googleSignUpBtn');
    const btnText = document.getElementById('googleBtnText');
    btn.disabled = true;
    btnText.textContent = 'Signing upâ€¦';

    try {
      const provider = new firebase.auth.GoogleAuthProvider();
      const result = await firebase.auth().signInWithPopup(provider);
      const idToken = await result.user.getIdToken();

      const response = await fetch('/auth/google-login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ idToken })
      });

      const data = await response.json();
      if (data.success) {
        window.location.href = data.redirect;
      } else {
        alert(data.error || 'Sign up failed. Please try again.');
        btn.disabled = false;
        btnText.textContent = 'Sign up with Google';
      }
    } catch (error) {
      console.error('Google sign-up error:', error);
      if (error.code !== 'auth/popup-closed-by-user') {
        alert('Google sign-up failed. Please try again.');
      }
      btn.disabled = false;
      btnText.textContent = 'Sign up with Google';
    }
  }
</script>
{% endblock %}