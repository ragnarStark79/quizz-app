{% extends "base.html" %}
{% block title %}Dashboard ‚Äì QuizOasis{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  /* ‚îÄ‚îÄ Light Trading-Terminal Dashboard ‚îÄ‚îÄ */
  .dash-shell {
    background: #f8fafc;
    min-height: 100vh;
    border-radius: var(--radius-xl);
    padding: var(--sp-8);
    color: #334155;
    position: relative;
    overflow: hidden
  }

  .dash-shell::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 260px;
    background: linear-gradient(135deg, rgba(99, 102, 241, .08), rgba(6, 182, 212, .05));
    pointer-events: none
  }

  .dash-header {
    display: flex;
    align-items: center;
    gap: var(--sp-4);
    flex-wrap: wrap;
    margin-bottom: var(--sp-6);
    position: relative;
    z-index: 1
  }

  .dash-avatar {
    width: 56px;
    height: 56px;
    border-radius: var(--radius-full);
    border: 2px solid rgba(99, 102, 241, .4);
    object-fit: cover;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--fs-xl);
    font-weight: 800;
    background: linear-gradient(135deg, #6366f1, #06b6d4);
    color: #fff;
    box-shadow: 0 4px 10px rgba(99, 102, 241, .2)
  }

  .dash-greeting {
    flex: 1
  }

  .dash-greeting h1 {
    margin: 0;
    font-size: var(--fs-xl);
    color: #0f172a;
    font-weight: 800
  }

  .dash-greeting p {
    margin: 2px 0 0;
    color: #64748b;
    font-size: var(--fs-sm)
  }

  .dash-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border-radius: var(--radius-full);
    font-size: var(--fs-xs);
    font-weight: 700;
    background: rgba(99, 102, 241, .08);
    color: #4f46e5;
    border: 1px solid rgba(99, 102, 241, .2)
  }

  .dash-actions {
    display: flex;
    gap: var(--sp-2)
  }

  .dash-actions .btn {
    font-size: var(--fs-xs);
    padding: 8px 16px;
    box-shadow: 0 4px 6px -1px rgba(99, 102, 241, .1)
  }

  /* Metric cards */
  .metric-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: var(--sp-4);
    margin-bottom: var(--sp-6);
    position: relative;
    z-index: 1
  }

  @media(max-width:900px) {
    .metric-grid {
      grid-template-columns: repeat(3, 1fr)
    }
  }

  @media(max-width:600px) {
    .metric-grid {
      grid-template-columns: repeat(2, 1fr)
    }
  }

  .metric-card {
    background: #ffffff;
    border: 1px solid rgba(99, 102, 241, .15);
    border-radius: var(--radius-lg);
    padding: var(--sp-5);
    transition: all .25s;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.03), 0 2px 4px -2px rgba(0, 0, 0, 0.03);
  }

  .metric-card:hover {
    border-color: rgba(99, 102, 241, .35);
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(99, 102, 241, .12)
  }

  .metric-icon {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    margin-bottom: var(--sp-3)
  }

  .metric-value {
    font-size: var(--fs-2xl);
    font-weight: 900;
    color: #0f172a;
    margin-bottom: 2px;
    font-variant-numeric: tabular-nums
  }

  .metric-label {
    font-size: var(--fs-xs);
    color: #64748b;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .06em
  }

  /* Chart panels */
  .chart-grid {
    display: grid;
    gap: var(--sp-5);
    grid-template-columns: 1.6fr 1fr;
    margin-bottom: var(--sp-5);
    position: relative;
    z-index: 1
  }

  @media(max-width:768px) {
    .chart-grid {
      grid-template-columns: 1fr
    }
  }

  .dash-panel {
    background: #ffffff;
    border: 1px solid rgba(99, 102, 241, .15);
    border-radius: var(--radius-lg);
    padding: var(--sp-5);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.03)
  }

  .dash-panel h3 {
    margin: 0 0 var(--sp-4);
    font-size: var(--fs-md);
    color: #1e293b;
    font-weight: 700
  }

  .dash-panel .sub {
    font-size: var(--fs-xs);
    color: #64748b
  }

  /* Activity feed */
  .activity-row {
    display: flex;
    align-items: center;
    gap: var(--sp-3);
    padding: var(--sp-3) 0;
    border-bottom: 1px solid #f1f5f9
  }

  .activity-row:last-child {
    border-bottom: none
  }

  .activity-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0
  }

  .activity-name {
    flex: 1;
    font-weight: 600;
    font-size: var(--fs-sm);
    color: #1e293b;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis
  }

  .activity-score {
    font-weight: 800;
    font-size: var(--fs-sm);
    font-variant-numeric: tabular-nums
  }

  .activity-date {
    font-size: var(--fs-xs);
    color: #64748b;
    min-width: 72px;
    text-align: right
  }

  /* Gauge */
  .gauge-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1
  }

  .gauge-center {
    font-size: var(--fs-2xl);
    font-weight: 900;
    color: #0f172a
  }

  .gauge-sub {
    font-size: var(--fs-xs);
    color: #64748b;
    margin-top: 2px
  }

  /* Quizzes strip */
  .quiz-strip {
    display: flex;
    align-items: center;
    gap: var(--sp-3);
    padding: var(--sp-3) 0;
    border-bottom: 1px solid #f1f5f9
  }

  .quiz-strip:last-child {
    border-bottom: none
  }

  .quiz-strip:hover {
    background: #f8fafc;
    border-radius: var(--radius-sm)
  }

  /* AI limit ring */
  .ai-ring {
    position: relative;
    width: 56px;
    height: 56px
  }

  .ai-ring svg {
    width: 100%;
    height: 100%
  }

  .ai-ring .ring-text {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--fs-sm);
    font-weight: 900;
    color: #4f46e5
  }
</style>
{% endblock %}

{% block content %}
<div class="page-shell" style="background:transparent;padding:0;">
  <div class="dash-shell">

    <!-- ‚îÄ‚îÄ‚îÄ Skeleton ‚îÄ‚îÄ‚îÄ -->
    <div id="skelDash">
      <div style="display:flex;align-items:center;gap:var(--sp-4);margin-bottom:var(--sp-6);">
        <div class="skeleton"
          style="width:56px;height:56px;border-radius:var(--radius-full);background:rgba(99,102,241,.08);"></div>
        <div>
          <div class="skeleton" style="width:180px;height:20px;margin-bottom:6px;background:rgba(99,102,241,.08);">
          </div>
          <div class="skeleton" style="width:120px;height:14px;background:rgba(99,102,241,.06);"></div>
        </div>
      </div>
      <div class="metric-grid">
        {% for i in range(5) %}<div class="skeleton"
          style="height:110px;border-radius:var(--radius-lg);background:rgba(99,102,241,.06);"></div>{% endfor %}
      </div>
      <div class="chart-grid">
        <div class="skeleton" style="height:280px;border-radius:var(--radius-lg);background:rgba(99,102,241,.06);">
        </div>
        <div class="skeleton" style="height:280px;border-radius:var(--radius-lg);background:rgba(99,102,241,.06);">
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ Real Dashboard ‚îÄ‚îÄ‚îÄ -->
    <div id="realDash" style="display:none;">

      <!-- Header -->
      <div class="dash-header anim-fade">
        {% if current_user.profile_image %}
        <img src="{{ url_for('static', filename=current_user.profile_image) }}" alt="Avatar" class="dash-avatar">
        {% else %}
        <div class="dash-avatar">{{ current_user.username[0]|upper }}</div>
        {% endif %}
        <div class="dash-greeting">
          <h1>{{ current_user.username }}</h1>
          <p>{{ current_user.email }}</p>
        </div>
        <div class="dash-pill">
          <span>‚ú® AI</span>
          <span
            style="color:{% if ai_remaining > 3 %}#10b981{% elif ai_remaining > 0 %}#f59e0b{% else %}#ef4444{% endif %};font-weight:900;">{{
            ai_remaining }}/{{ ai_limit }}</span>
          <span>left today</span>
        </div>
        <div class="dash-actions">
          <a href="{{ url_for('quiz.ai_generate_page') }}" class="btn btn-secondary">‚ú® AI Generate</a>
          <a href="{{ url_for('quiz.create_quiz') }}" class="btn btn-primary">+ Create</a>
        </div>
      </div>

      <!-- Metric cards -->
      <div class="metric-grid">
        <div class="metric-card anim-slide anim-stagger" style="--i:0;">
          <div class="metric-icon" style="background:rgba(99,102,241,.15);color:#818cf8;">üéÆ</div>
          <div class="metric-value" data-count="{{ total_attempts }}">0</div>
          <div class="metric-label">Quizzes Played</div>
        </div>
        <div class="metric-card anim-slide anim-stagger" style="--i:1;">
          <div class="metric-icon" style="background:rgba(16,185,129,.15);color:#10b981;">üéØ</div>
          <div class="metric-value" data-count="{{ avg_accuracy|round|int }}">0</div>
          <div class="metric-label">Avg Accuracy %</div>
        </div>
        <div class="metric-card anim-slide anim-stagger" style="--i:2;">
          <div class="metric-icon" style="background:rgba(245,158,11,.15);color:#f59e0b;">üèÜ</div>
          <div class="metric-value" data-count="{{ best_score|round|int }}">0</div>
          <div class="metric-label">Best Score %</div>
        </div>
        <div class="metric-card anim-slide anim-stagger" style="--i:3;">
          <div class="metric-icon" style="background:rgba(6,182,212,.15);color:#06b6d4;">üìù</div>
          <div class="metric-value" data-count="{{ quizzes_created }}">0</div>
          <div class="metric-label">Quizzes Created</div>
        </div>
        <div class="metric-card anim-slide anim-stagger" style="--i:4;">
          <div class="metric-icon" style="background:rgba(139,92,246,.15);color:#a78bfa;">ü§ñ</div>
          <div class="ai-ring">
            <svg viewBox="0 0 36 36">
              <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none"
                stroke="rgba(99,102,241,.15)" stroke-width="3" />
              <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none"
                stroke="#818cf8" stroke-width="3" stroke-dasharray="{{ (ai_remaining / ai_limit * 100)|round }}, 100"
                stroke-linecap="round" />
            </svg>
            <div class="ring-text">{{ ai_remaining }}</div>
          </div>
          <div class="metric-label">AI Gens Left</div>
        </div>
      </div>

      <!-- Charts row -->
      <div class="chart-grid">
        <!-- Score History ‚Äî line/area chart -->
        <div class="dash-panel anim-slide" style="--i:5;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--sp-4);">
            <h3 style="margin:0;">üìà Performance</h3>
            <span class="sub">Last {{ score_values|length }} attempts</span>
          </div>
          {% if score_values %}
          <canvas id="scoreChart" height="180"></canvas>
          {% else %}
          <div style="text-align:center;padding:var(--sp-10);color:#475569;">
            <div style="font-size:2rem;margin-bottom:var(--sp-2);">üìä</div>
            <p>No data yet ‚Äî take a quiz!</p>
            <a href="{{ url_for('quiz.explore_quizzes') }}" class="btn btn-primary btn-sm"
              style="margin-top:var(--sp-3);">Explore Quizzes</a>
          </div>
          {% endif %}
        </div>

        <!-- Accuracy gauge -->
        <div class="dash-panel anim-slide" style="--i:6;">
          <h3>üéØ Accuracy</h3>
          {% if total_qs > 0 %}
          <div class="gauge-wrap">
            <canvas id="accChart" style="max-width:170px;"></canvas>
            <div class="gauge-center" style="margin-top:-40px;">{{ avg_accuracy|round|int }}%</div>
            <div class="gauge-sub">{{ correct_count }} correct ¬∑ {{ wrong_count }} wrong</div>
          </div>
          {% else %}
          <div class="gauge-wrap" style="padding:var(--sp-8);">
            <p style="color:#475569;">No data yet</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Bottom row: Activity feed + My Quizzes -->
      <div class="chart-grid" style="grid-template-columns:1fr 1fr;">

        <!-- Recent Activity -->
        <div class="dash-panel anim-slide" style="--i:7;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--sp-3);">
            <h3 style="margin:0;">üìã Recent Activity</h3>
            <a href="{{ url_for('quiz.explore_quizzes') }}"
              style="font-size:var(--fs-xs);font-weight:600;color:#4f46e5;">Explore ‚Üí</a>
          </div>
          {% if recent_attempts %}
          {% for attempt in recent_attempts %}
          <div class="activity-row">
            <div class="activity-dot"
              style="background:{% if attempt.accuracy >= 70 %}#10b981{% elif attempt.accuracy >= 40 %}#f59e0b{% else %}#ef4444{% endif %};box-shadow:0 0 6px {% if attempt.accuracy >= 70 %}rgba(16,185,129,.4){% elif attempt.accuracy >= 40 %}rgba(245,158,11,.4){% else %}rgba(239,68,68,.4){% endif %};">
            </div>
            <div class="activity-name">{{ attempt.quiz.title }}</div>
            <div class="activity-score"
              style="color:{% if attempt.accuracy >= 70 %}#10b981{% elif attempt.accuracy >= 40 %}#f59e0b{% else %}#ef4444{% endif %};">
              {{ attempt.accuracy|round|int }}%</div>
            <div class="activity-date">{{ attempt.submitted_at.strftime('%b %d') }}</div>
          </div>
          {% endfor %}
          {% else %}
          <p style="color:#475569;text-align:center;padding:var(--sp-6);">No attempts yet</p>
          {% endif %}
        </div>

        <!-- My Quizzes -->
        <div class="dash-panel anim-slide" style="--i:8;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--sp-3);">
            <h3 style="margin:0;">üß© My Quizzes</h3>
            <a href="{{ url_for('quiz.list_quizzes') }}"
              style="font-size:var(--fs-xs);font-weight:600;color:#4f46e5;">See all ‚Üí</a>
          </div>
          {% if quizzes %}
          {% for quiz in quizzes[:5] %}
          <div class="quiz-strip">
            <div style="flex:1;min-width:0;">
              <div
                style="font-weight:700;color:#1e293b;font-size:var(--fs-sm);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                {{ quiz.title }}</div>
              <div style="font-size:var(--fs-xs);color:#64748b;">
                {{ quiz.questions.count() }} questions
                {% if quiz.is_ai_generated %}
                &bull; <span style="color:#8b5cf6; font-weight:600;">‚ú® Generated by GenAI</span>
                {% endif %}
              </div>
            </div>
            {% if quiz.status == 'active' %}<span class="badge badge-success" style="font-size:10px;">Active</span>
            {% elif quiz.status == 'draft' %}<span class="badge badge-neutral" style="font-size:10px;">Draft</span>
            {% elif quiz.status == 'scheduled' %}<span class="badge badge-info" style="font-size:10px;">Scheduled</span>
            {% elif quiz.status == 'suspended' %}<span class="badge badge-danger"
              style="font-size:10px;">Suspended</span>
            {% else %}<span class="badge badge-neutral" style="font-size:10px;">{{ quiz.status }}</span>{% endif %}
            <span style="font-size:var(--fs-xs);color:#64748b;min-width:48px;text-align:right;">{{
              attempt_counts.get(quiz.id, 0) }} ‚ñ∂</span>
          </div>
          {% endfor %}
          {% else %}
          <div style="text-align:center;padding:var(--sp-6);color:#475569;">
            <p>No quizzes yet. <a href="{{ url_for('quiz.create_quiz') }}" style="font-weight:700;color:#818cf8;">Create
                one!</a></p>
          </div>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Skeleton ‚Üí real
  setTimeout(() => {
    document.getElementById('skelDash').style.display = 'none';
    document.getElementById('realDash').style.display = 'block';
    animateCounters();
    initCharts();
  }, 900);

  // Animated counters
  function animateCounters() {
    document.querySelectorAll('[data-count]').forEach(el => {
      const target = parseInt(el.dataset.count) || 0;
      if (target === 0) { el.textContent = '0'; return; }
      let current = 0;
      const step = Math.max(1, Math.ceil(target / 40));
      const interval = setInterval(() => {
        current += step;
        if (current >= target) { current = target; clearInterval(interval); }
        el.textContent = current;
      }, 25);
    });
  }

  // Charts
  function initCharts() {
    {% if score_values %}
    const scoreLabels = {{ score_labels | tojson
  }};
  const scoreValues = {{ score_values | tojson }};

  const scoreCtx = document.getElementById('scoreChart');
  if (scoreCtx) {
    const gradient = scoreCtx.getContext('2d').createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, 'rgba(99,102,241,.35)');
    gradient.addColorStop(1, 'rgba(99,102,241,.02)');

    new Chart(scoreCtx, {
      type: 'line',
      data: {
        labels: scoreLabels,
        datasets: [{
          data: scoreValues,
          borderColor: '#4f46e5',
          backgroundColor: gradient,
          fill: true,
          tension: .4,
          borderWidth: 2.5,
          pointBackgroundColor: '#4f46e5',
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2,
          pointRadius: 4,
          pointHoverRadius: 6,
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            grid: { color: 'rgba(99,102,241,.06)' },
            ticks: { color: '#475569', font: { size: 11 } },
            border: { display: false }
          },
          x: {
            grid: { display: false },
            ticks: { color: '#475569', font: { size: 10 } },
            border: { display: false }
          }
        }
      }
    });
  }
  {% endif %}

  {% if total_qs > 0 %}
  const accCtx = document.getElementById('accChart');
  if (accCtx) {
    new Chart(accCtx, {
      type: 'doughnut',
      data: {
        labels: ['Correct', 'Wrong'],
        datasets: [{
          data: [{{ correct_count }}, {{ wrong_count }}],
      backgroundColor: ['#10b981', '#ef4444'],
      borderWidth: 0,
      borderRadius: 4,
    }]
        },
  options: {
    responsive: true,
      cutout: '75%',
        plugins: { legend: { display: false } }
  }
      });
    }
  {% endif %}
  }
</script>
{% endblock %}